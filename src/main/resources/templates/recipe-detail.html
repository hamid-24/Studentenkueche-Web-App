<!DOCTYPE html>
<html lang="en" data-bs-theme="dark" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments :: head (recipes)}">
</head>

<body>
<div class="container-xxl">
    <!--Header Fragments-->
    <div class="mb-4">
        <div class="bg-secondary-subtle" th:insert="~{fragments :: header}"></div>
        <header th:replace="~{fragments2 :: header2}"></header>
    </div>

    <div th:object="${recipe}" class="thymeleaf-detail-view position-relative">
        <!-- Favorite Icon -->
        <a class="favorite position-absolute" style="top: 1em; left: 1em"
           th:href="'/recipes/favorite/' + ${recipe.getId()}">
            <svg th:styleappend="${session.me.getFavoriteRecipes().contains(recipe) ? 'fill: red;' : 'fill: black;'}"
                 xmlns="http://www.w3.org/2000/svg" height="2em" viewBox="0 0 512 512">
                <!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
                <path d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/>
            </svg>
        </a>

        <!-- Recipe Image -->
        <div style="max-width: 15em; height: 15em">
            <img th:src="'/'+ ${recipe.getImagePath()}" style="width: 100%; height: 100%; object-fit: cover" class="rounded-5" alt="no image">
        </div>

        <div class="d-flex flex-column gap-1 flex-grow-1">
            <!-- Recipe Name -->
            <div class="fs-1 fw-semibold text-center" th:utext="${recipe.getName()}"></div>
            <hr/>

            <!-- Recipe Ratings -->
            <p>Average Rating: &#x2605;<span th:text="${averageRating}"></span></p>
            <p>Your Rating: &#x2605;<span th:text="${userRating}"></span></p>
            <div class="rating-form-container">
                <form th:action="@{/recipes/rate/{id}(id=${recipe.id})}" method="post" id="ratingForm" class="rating-form">
                    <link rel="stylesheet" href="/css/styles.css">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <label class="rating-label">Rate this recipe:</label>
                        </div>
                        <div class="col-auto">
                            <div class="rating-stars">
                                <span class="star selected" data-rating="1">&#9733;</span>
                                <span class="star" data-rating="2">&#9733;</span>
                                <span class="star" data-rating="3">&#9733;</span>
                                <span class="star" data-rating="4">&#9733;</span>
                                <span class="star" data-rating="5">&#9733;</span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <input type="hidden" name="rating" id="ratingValue" value="0" />
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="d-flex mb-3 p-2 h-20 w-20 fs-4 btn btn-warning rounded-pill">
                                &#9733; Rate
                            </button>
                        </div>
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            const stars = document.querySelectorAll('.star');
                            const ratingValue = document.getElementById('ratingValue');
                            const userRating = [[${userRating}]];

                            stars.forEach((star, index) => {
                                star.addEventListener('click', function () {
                                    ratingValue.value = this.getAttribute('data-rating');
                                    stars.forEach((star, i) => {
                                        star.classList.remove('selected');
                                    });
                                    for (let i = 0; i <= index; i++) {
                                        stars[i].classList.add('selected');
                                    }
                                });

                                if (index < userRating) {
                                    star.classList.add('selected');
                                }
                            });
                        });
                    </script>
                </form>
            </div>
            <hr/>

            <!-- Recipe Time, Difficulty, Calories, Price and Categories -->
            <p>Time: <span th:text="${recipe.getTime()}"></span> minutes</p>
            <p>Difficulty: <span th:text="${recipe.getDifficulty()}"></span></p>
            <p>Calories: <span th:text="${recipe.getCalories()}"></span> kcal</p>
            <p>Price: <span th:text="${recipe.getPrice()}"></span> â‚¬ </p>
            <p>Categories: <span th:each="category : ${recipe.getCategories()}" th:text="${category} + ' | '"></span></p>
            <hr/>

            <!-- Recipe Ingredients -->
            <p class = "fs-3">Ingredients:</p>
            <ul class="list-group">
                <li class ="list-group-item" th:each="ingredient : ${recipe.getIngredients()}" th:text="${ingredient}"></li>
            </ul>

            <!-- Recipe Preparation -->
            <p class = "fs-3">Preparation:</p>
            <div th:utext="${recipe.getPreparation()}"></div>
            <div class="mt-3"></div>
            <hr/>

            <!-- Recipe Creator -->
            <p>User: <span th:text="'Created by ' + ${recipe.getUser().getUsername()}"></span></p>
        </div>
    </div>
    <script src="/js/favoriteToggle.js"></script>
</div>

</body>
</html>